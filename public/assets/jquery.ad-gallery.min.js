/**
 * Copyright (c) 2012 Anders Ekdahl (http://coffeescripter.com/)
 * Dual licensed under the MIT (http://www.opensource.org/licenses/mit-license.php)
 * and GPL (http://www.opensource.org/licenses/gpl-license.php) licenses.
 *
 * Version: 1.2.7
 *
 * Demo and documentation: http://coffeescripter.com/code/ad-gallery/
 */
(function(e){function t(e,t,n){var r=parseInt(e.css("top"),10);if(t=="left"){var i="-"+this.image_wrapper_height+"px";e.css("top",this.image_wrapper_height+"px")}else{var i=this.image_wrapper_height+"px";e.css("top","-"+this.image_wrapper_height+"px")}return n&&(n.css("bottom","-"+n[0].offsetHeight+"px"),n.animate({bottom:0},this.settings.animation_speed*2)),this.current_description&&this.current_description.animate({bottom:"-"+this.current_description[0].offsetHeight+"px"},this.settings.animation_speed*2),{old_image:{top:i},new_image:{top:r}}}function n(e,t,n){var r=parseInt(e.css("left"),10);if(t=="left"){var i="-"+this.image_wrapper_width+"px";e.css("left",this.image_wrapper_width+"px")}else{var i=this.image_wrapper_width+"px";e.css("left","-"+this.image_wrapper_width+"px")}return n&&(n.css("bottom","-"+n[0].offsetHeight+"px"),n.animate({bottom:0},this.settings.animation_speed*2)),this.current_description&&this.current_description.animate({bottom:"-"+this.current_description[0].offsetHeight+"px"},this.settings.animation_speed*2),{old_image:{left:i},new_image:{left:r}}}function r(e,t,n){var r=e.width(),i=e.height(),s=parseInt(e.css("left"),10),o=parseInt(e.css("top"),10);return e.css({width:0,height:0,top:this.image_wrapper_height/2,left:this.image_wrapper_width/2}),{old_image:{width:0,height:0,top:this.image_wrapper_height/2,left:this.image_wrapper_width/2},new_image:{width:r,height:i,top:o,left:s}}}function i(e,t,n){return e.css("opacity",0),{old_image:{opacity:0},new_image:{opacity:1}}}function s(e,t,n){return e.css("opacity",0),{old_image:{opacity:0},new_image:{opacity:1},speed:0}}function o(e,t){this.init(e,t)}function u(e,t){this.init(e,t)}e.fn.adGallery=function(t){var n={loader_image:"loader.gif",start_at_index:0,update_window_hash:!0,description_wrapper:!1,thumb_opacity:.7,animate_first_image:!1,animation_speed:400,width:!1,height:!1,display_next_and_prev:!0,display_back_and_forward:!0,scroll_jump:0,slideshow:{enable:!0,autostart:!0,speed:5e3,start_label:"Start",stop_label:"Stop",stop_on_scroll:!0,countdown_prefix:"(",countdown_sufix:")",onStart:!1,onStop:!1},effect:"slide-hori",enable_keyboard_move:!0,cycle:!0,hooks:{displayDescription:!1},callbacks:{init:!1,afterImageVisible:!1,beforeImageVisible:!1}},r=e.extend(!1,n,t);t&&t.slideshow&&(r.slideshow=e.extend(!1,n.slideshow,t.slideshow)),r.slideshow.enable||(r.slideshow.autostart=!1);var i=[];return e(this).each(function(){var e=new o(this,r);i[i.length]=e}),i},o.prototype={wrapper:!1,image_wrapper:!1,gallery_info:!1,nav:!1,loader:!1,preloads:!1,thumbs_wrapper:!1,thumbs_wrapper_width:0,scroll_back:!1,scroll_forward:!1,next_link:!1,prev_link:!1,slideshow:!1,image_wrapper_width:0,image_wrapper_height:0,current_index:-1,current_image:!1,current_description:!1,nav_display_width:0,settings:!1,images:!1,in_transition:!1,animations:!1,init:function(t,n){var r=this;this.wrapper=e(t),this.settings=n,this.setupElements(),this.setupAnimations(),this.settings.width?(this.image_wrapper_width=this.settings.width,this.image_wrapper.width(this.settings.width),this.wrapper.width(this.settings.width)):this.image_wrapper_width=this.image_wrapper.width(),this.settings.height?(this.image_wrapper_height=this.settings.height,this.image_wrapper.height(this.settings.height)):this.image_wrapper_height=this.image_wrapper.height(),this.nav_display_width=this.nav.width(),this.current_index=-1,this.current_image=!1,this.current_description=!1,this.in_transition=!1,this.findImages(),this.settings.display_next_and_prev&&this.initNextAndPrev();var i=function(e){return r.nextImage(e)};this.slideshow=new u(i,this.settings.slideshow),this.controls.append(this.slideshow.create()),this.settings.slideshow.enable?this.slideshow.enable():this.slideshow.disable(),this.settings.display_back_and_forward&&this.initBackAndForward(),this.settings.enable_keyboard_move&&this.initKeyEvents(),this.initHashChange();var s=parseInt(this.settings.start_at_index,10);typeof this.getIndexFromHash()!="undefined"&&(s=this.getIndexFromHash()),this.loading(!0),this.showImage(s,function(){r.settings.slideshow.autostart&&(r.preloadImage(s+1),r.slideshow.start())}),this.fireCallback(this.settings.callbacks.init)},setupAnimations:function(){this.animations={"slide-vert":t,"slide-hori":n,resize:r,fade:i,none:s}},setupElements:function(){this.controls=this.wrapper.find(".ad-controls"),this.gallery_info=e('<p class="ad-info"></p>'),this.controls.append(this.gallery_info),this.image_wrapper=this.wrapper.find(".ad-image-wrapper"),this.image_wrapper.empty(),this.nav=this.wrapper.find(".ad-nav"),this.thumbs_wrapper=this.nav.find(".ad-thumbs"),this.preloads=e('<div class="ad-preloads"></div>'),this.loader=e('<img class="ad-loader" src="'+this.settings.loader_image+'">'),this.image_wrapper.append(this.loader),this.loader.hide(),e(document.body).append(this.preloads)},loading:function(e){e?this.loader.show():this.loader.hide()},addAnimation:function(t,n){e.isFunction(n)&&(this.animations[t]=n)},findImages:function(){var t=this;this.images=[];var n=0,r=this.thumbs_wrapper.find("a"),i=r.length;this.settings.thumb_opacity<1&&r.find("img").css("opacity",this.settings.thumb_opacity),r.each(function(r){var i=e(this);i.data("ad-i",r);var s=i.attr("href"),o=i.find("img");t.whenImageLoaded(o[0],function(){var e=o[0].parentNode.parentNode.offsetWidth;o[0].width==0&&(e=100),t.thumbs_wrapper_width+=e,n++}),t._initLink(i),t.images[r]=t._createImageData(i,s)});var s=setInterval(function(){i==n&&(t._setThumbListWidth(t.thumbs_wrapper_width),clearInterval(s))},100)},_setThumbListWidth:function(e){e-=100;var t=this.nav.find(".ad-thumb-list");t.css("width",e+"px");var n=1,r=t.height();while(n<201){t.css("width",e+n+"px");if(r!=t.height())break;r=t.height(),n++}t.width()<this.nav.width()&&t.width(this.nav.width())},_initLink:function(t){var n=this;t.click(function(){return n.showImage(t.data("ad-i")),n.slideshow.stop(),!1}).hover(function(){!e(this).is(".ad-active")&&n.settings.thumb_opacity<1&&e(this).find("img").fadeTo(300,1),n.preloadImage(t.data("ad-i"))},function(){!e(this).is(".ad-active")&&n.settings.thumb_opacity<1&&e(this).find("img").fadeTo(300,n.settings.thumb_opacity)})},_createImageData:function(e,t){var n=!1,r=e.find("img");r.data("ad-link")?n=e.data("ad-link"):r.attr("longdesc")&&r.attr("longdesc").length&&(n=r.attr("longdesc"));var i=!1;r.data("ad-desc")?i=r.data("ad-desc"):r.attr("alt")&&r.attr("alt").length&&(i=r.attr("alt"));var s=!1;return r.data("ad-title")?s=r.data("ad-title"):r.attr("title")&&r.attr("title").length&&(s=r.attr("title")),{thumb_link:e,image:t,error:!1,preloaded:!1,desc:i,title:s,size:!1,link:n}},initKeyEvents:function(){var t=this;e(document).keydown(function(e){e.keyCode==39?(t.nextImage(),t.slideshow.stop()):e.keyCode==37&&(t.prevImage(),t.slideshow.stop())})},getIndexFromHash:function(){if(window.location.hash&&window.location.hash.indexOf("#ad-image-")===0){var e=window.location.hash.replace(/^#ad-image-/g,""),t=this.thumbs_wrapper.find("#"+e);if(t.length)return this.thumbs_wrapper.find("a").index(t);if(!isNaN(parseInt(e,10)))return parseInt(e,10)}return undefined},removeImage:function(t){if(t<0||t>=this.images.length)throw"Cannot remove image for index "+t;var n=this.images[t];this.images.splice(t,1);var r=n.thumb_link,i=r[0].parentNode.offsetWidth;this.thumbs_wrapper_width-=i,r.remove(),this._setThumbListWidth(this.thumbs_wrapper_width),this.gallery_info.html(this.current_index+1+" / "+this.images.length),this.thumbs_wrapper.find("a").each(function(t){e(this).data("ad-i",t)}),t==this.current_index&&this.images.length!=0&&this.showImage(0)},removeAllImages:function(){for(var e=this.images.length-1;e>=0;e--)this.removeImage(e)},addImage:function(t,n,r,i,s){r=r||"",i=i||"",s=s||"";var o=e('<li><a href="'+n+'" id="'+r+'">'+'<img src="'+t+'" title="'+i+'" alt="'+s+'">'+"</a></li>"),u=this;this.thumbs_wrapper.find("ul").append(o);var a=o.find("a"),f=a.find("img");f.css("opacity",this.settings.thumb_opacity),this.whenImageLoaded(f[0],function(){var e=f[0].parentNode.parentNode.offsetWidth;f[0].width==0&&(e=100),u.thumbs_wrapper_width+=e,u._setThumbListWidth(u.thumbs_wrapper_width)});var l=this.images.length;a.data("ad-i",l),this._initLink(a),this.images[l]=u._createImageData(a,n),this.gallery_info.html(this.current_index+1+" / "+this.images.length)},initHashChange:function(){var t=this;if("onhashchange"in window)e(window).bind("hashchange",function(){var e=t.getIndexFromHash();typeof e!="undefined"&&e!=t.current_index&&t.showImage(e)});else{var n=window.location.hash;setInterval(function(){if(window.location.hash!=n){n=window.location.hash;var e=t.getIndexFromHash();typeof e!="undefined"&&e!=t.current_index&&t.showImage(e)}},200)}},initNextAndPrev:function(){this.next_link=e('<div class="ad-next"><div class="ad-next-image"></div></div>'),this.prev_link=e('<div class="ad-prev"><div class="ad-prev-image"></div></div>'),this.image_wrapper.append(this.next_link),this.image_wrapper.append(this.prev_link);var t=this;this.prev_link.add(this.next_link).mouseover(function(n){e(this).css("height",t.image_wrapper_height),e(this).find("div").show()}).mouseout(function(t){e(this).find("div").hide()}).click(function(){e(this).is(".ad-next")?(t.nextImage(),t.slideshow.stop()):(t.prevImage(),t.slideshow.stop())}).find("div").css("opacity",.7)},initBackAndForward:function(){var t=this;this.scroll_forward=e('<div class="ad-forward"></div>'),this.scroll_back=e('<div class="ad-back"></div>'),this.nav.append(this.scroll_forward),this.nav.prepend(this.scroll_back);var n=0,r=!1;e(this.scroll_back).add(this.scroll_forward).click(function(){var n=t.nav_display_width-50;if(t.settings.scroll_jump>0)var n=t.settings.scroll_jump;if(e(this).is(".ad-forward"))var r=t.thumbs_wrapper.scrollLeft()+n;else var r=t.thumbs_wrapper.scrollLeft()-n;return t.settings.slideshow.stop_on_scroll&&t.slideshow.stop(),t.thumbs_wrapper.animate({scrollLeft:r+"px"}),!1}).css("opacity",.6).hover(function(){var i="left";e(this).is(".ad-forward")&&(i="right"),r=setInterval(function(){n++,n>30&&t.settings.slideshow.stop_on_scroll&&t.slideshow.stop();var e=t.thumbs_wrapper.scrollLeft()+1;i=="left"&&(e=t.thumbs_wrapper.scrollLeft()-1),t.thumbs_wrapper.scrollLeft(e)},10),e(this).css("opacity",1)},function(){n=0,clearInterval(r),e(this).css("opacity",.6)})},_afterShow:function(){this.gallery_info.html(this.current_index+1+" / "+this.images.length),this.settings.cycle||(this.prev_link.show().css("height",this.image_wrapper_height),this.next_link.show().css("height",this.image_wrapper_height),this.current_index==this.images.length-1&&this.next_link.hide(),this.current_index==0&&this.prev_link.hide());if(this.settings.update_window_hash){var e=this.images[this.current_index].thumb_link;e.attr("id")?window.location.hash="#ad-image-"+e.attr("id"):window.location.hash="#ad-image-"+this.current_index}this.fireCallback(this.settings.callbacks.afterImageVisible)},_getContainedImageSize:function(e,t){if(t>this.image_wrapper_height){var n=e/t;t=this.image_wrapper_height,e=this.image_wrapper_height*n}if(e>this.image_wrapper_width){var n=t/e;e=this.image_wrapper_width,t=this.image_wrapper_width*n}return{width:e,height:t}},_centerImage:function(e,t,n){e.css("top","0px");if(n<this.image_wrapper_height){var r=this.image_wrapper_height-n;e.css("top",r/2+"px")}e.css("left","0px");if(t<this.image_wrapper_width){var r=this.image_wrapper_width-t;e.css("left",r/2+"px")}},_getDescription:function(t){var n=!1;if(t.desc.length||t.title.length){var r="";t.title.length&&(r='<strong class="ad-description-title">'+t.title+"</strong>");var n="";t.desc.length&&(n="<span>"+t.desc+"</span>"),n=e('<p class="ad-image-description">'+r+n+"</p>")}return n},showImage:function(e,t){if(this.images[e]&&!this.in_transition&&e!=this.current_index){var n=this,r=this.images[e];this.in_transition=!0,r.preloaded?this._showWhenLoaded(e,t):(this.loading(!0),this.preloadImage(e,function(){n.loading(!1),n._showWhenLoaded(e,t)}))}},_showWhenLoaded:function(t,n){if(this.images[t]){var r=this,i=this.images[t],s=e(document.createElement("div")).addClass("ad-image"),o=e(new Image).attr("src",i.image);if(i.link){var u=e('<a href="'+i.link+'" target="_blank"></a>');u.append(o),s.append(u)}else s.append(o);this.image_wrapper.prepend(s);var a=this._getContainedImageSize(i.size.width,i.size.height);o.attr("width",a.width),o.attr("height",a.height),s.css({width:a.width+"px",height:a.height+"px"}),this._centerImage(s,a.width,a.height);var f=this._getDescription(i);if(f)if(!this.settings.description_wrapper&&!this.settings.hooks.displayDescription){s.append(f);var l=a.width-parseInt(f.css("padding-left"),10)-parseInt(f.css("padding-right"),10);f.css("width",l+"px")}else if(this.settings.hooks.displayDescription)this.settings.hooks.displayDescription.call(this,i);else{var c=this.settings.description_wrapper;c.append(f)}this.highLightThumb(this.images[t].thumb_link);var h="right";this.current_index<t&&(h="left"),this.fireCallback(this.settings.callbacks.beforeImageVisible);if(this.current_image||this.settings.animate_first_image){var p=this.settings.animation_speed,d="swing",v=this.animations[this.settings.effect].call(this,s,h,f);typeof v.speed!="undefined"&&(p=v.speed),typeof v.easing!="undefined"&&(d=v.easing);if(this.current_image){var m=this.current_image,g=this.current_description;m.animate(v.old_image,p,d,function(){m.remove(),g&&g.remove()})}s.animate(v.new_image,p,d,function(){r.current_index=t,r.current_image=s,r.current_description=f,r.in_transition=!1,r._afterShow(),r.fireCallback(n)})}else this.current_index=t,this.current_image=s,r.current_description=f,this.in_transition=!1,r._afterShow(),this.fireCallback(n)}},nextIndex:function(){if(this.current_index==this.images.length-1){if(!this.settings.cycle)return!1;var e=0}else var e=this.current_index+1;return e},nextImage:function(e){var t=this.nextIndex();return t===!1?!1:(this.preloadImage(t+1),this.showImage(t,e),!0)},prevIndex:function(){if(this.current_index==0){if(!this.settings.cycle)return!1;var e=this.images.length-1}else var e=this.current_index-1;return e},prevImage:function(e){var t=this.prevIndex();return t===!1?!1:(this.preloadImage(t-1),this.showImage(t,e),!0)},preloadAll:function(){function n(){t<e.images.length&&(t++,e.preloadImage(t,n))}var e=this,t=0;e.preloadImage(t,n)},preloadImage:function(t,n){if(this.images[t]){var r=this.images[t];if(!this.images[t].preloaded){var i=e(new Image);i.attr("src",r.image);if(!this.isImageLoaded(i[0])){this.preloads.append(i);var s=this;i.load(function(){r.preloaded=!0,r.size={width:this.width,height:this.height},s.fireCallback(n)}).error(function(){r.error=!0,r.preloaded=!1,r.size=!1})}else r.preloaded=!0,r.size={width:i[0].width,height:i[0].height},this.fireCallback(n)}else this.fireCallback(n)}},whenImageLoaded:function(t,n){this.isImageLoaded(t)?n&&n():e(t).load(n)},isImageLoaded:function(e){return typeof e.complete!="undefined"&&!e.complete?!1:typeof e.naturalWidth!="undefined"&&e.naturalWidth==0?!1:!0},highLightThumb:function(e){this.thumbs_wrapper.find(".ad-active").removeClass("ad-active"),e.addClass("ad-active"),this.settings.thumb_opacity<1&&(this.thumbs_wrapper.find("a:not(.ad-active) img").fadeTo(300,this.settings.thumb_opacity),e.find("img").fadeTo(300,1));var t=e[0].parentNode.offsetLeft;t-=this.nav_display_width/2-e[0].offsetWidth/2,this.thumbs_wrapper.animate({scrollLeft:t+"px"})},fireCallback:function(t){e.isFunction(t)&&t.call(this)}},u.prototype={start_link:!1,stop_link:!1,countdown:!1,controls:!1,settings:!1,nextimage_callback:!1,enabled:!1,running:!1,countdown_interval:!1,init:function(e,t){var n=this;this.nextimage_callback=e,this.settings=t},create:function(){this.start_link=e('<span class="ad-slideshow-start">'+this.settings.start_label+"</span>"),this.stop_link=e('<span class="ad-slideshow-stop">'+this.settings.stop_label+"</span>"),this.countdown=e('<span class="ad-slideshow-countdown"></span>'),this.controls=e('<div class="ad-slideshow-controls"></div>'),this.controls.append(this.start_link).append(this.stop_link).append(this.countdown),this.countdown.hide();var t=this;return this.start_link.click(function(){t.start()}),this.stop_link.click(function(){t.stop()}),e(document).keydown(function(e){e.keyCode==83&&(t.running?t.stop():t.start())}),this.controls},disable:function(){this.enabled=!1,this.stop(),this.controls.hide()},enable:function(){this.enabled=!0,this.controls.show()},toggle:function(){this.enabled?this.disable():this.enable()},start:function(){if(this.running||!this.enabled)return!1;var e=this;return this.running=!0,this.controls.addClass("ad-slideshow-running"),this._next(),this.fireCallback(this.settings.onStart),!0},stop:function(){return this.running?(this.running=!1,this.countdown.hide(),this.controls.removeClass("ad-slideshow-running"),clearInterval(this.countdown_interval),this.fireCallback(this.settings.onStop),!0):!1},_next:function(){var e=this,t=this.settings.countdown_prefix,n=this.settings.countdown_sufix;clearInterval(e.countdown_interval),this.countdown.show().html(t+this.settings.speed/1e3+n);var r=0;this.countdown_interval=setInterval(function(){r+=1e3;if(r>=e.settings.speed){var i=function(){e.running&&e._next(),r=0};e.nextimage_callback(i)||e.stop(),r=0}var s=parseInt(e.countdown.text().replace(/[^0-9]/g,""),10);s--,s>0&&e.countdown.html(t+s+n)},1e3)},fireCallback:function(t){e.isFunction(t)&&t.call(this)}}})(jQuery);